#!/bin/bash

# Create pem file
cat << 'EOF' > /home/vagrant/.ssh/ansible.pem
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAvpXC4eaopo5tixx44BkkQL1X0Ux5ddD7bVX5oF7raATAC/+/pasO
Xs9n7WrI7hqv2pxQUmHfFRnCfaOosa31kxslyAkJ5n/pXVvliicS27efBu5pj2h1FSu/0l
/9ZqZkKyT0Sgfl+wo5atkUKA87B0xqI/aQXcXQUVhAnrw7fVd41hEdzNb+p+cQzkDyQH0G
IVvAGTlbNW2zfHbALFHmSniUEZtjX7YGv5ybZTRhhAQKTSxZH4WSGjPUMw1togM9il6c9s
KmrZ9QMRpzEI0E4xs1HQGkiVdtduA8GBR1Pl5ZigYtLbTsTd0AN54LMxp5JPg9V64NxelA
Kle4cXtQt9qSEPIfkUfasOQgwdKJcgdNQPXM6rDgHDx43lwFZYCNt/UW3ozgQ0/SP4/pIy
xidCKJBAF8CfoQphn+dexqE9y8nx/8tsEk4q1zjo6WyfqjrQ0eXTvTb4AI9KKH6T/axdmU
0RneZWbcFI4ALNOix+gC8kQ689NDe+Ipn4HFhLZRAAAFkOGuc1zhrnNcAAAAB3NzaC1yc2
EAAAGBAL6VwuHmqKaObYsceOAZJEC9V9FMeXXQ+21V+aBe62gEwAv/v6WrDl7PZ+1qyO4a
r9qcUFJh3xUZwn2jqLGt9ZMbJcgJCeZ/6V1b5YonEtu3nwbuaY9odRUrv9Jf/WamZCsk9E
oH5fsKOWrZFCgPOwdMaiP2kF3F0FFYQJ68O31XeNYRHczW/qfnEM5A8kB9BiFbwBk5WzVt
s3x2wCxR5kp4lBGbY1+2Br+cm2U0YYQECk0sWR+Fkhoz1DMNbaIDPYpenPbCpq2fUDEacx
CNBOMbNR0BpIlXbXbgPBgUdT5eWYoGLS207E3dADeeCzMaeST4PVeuDcXpQCpXuHF7ULfa
khDyH5FH2rDkIMHSiXIHTUD1zOqw4Bw8eN5cBWWAjbf1Ft6M4ENP0j+P6SMsYnQiiQQBfA
n6EKYZ/nXsahPcvJ8f/LbBJOKtc46Olsn6o60NHl0702+ACPSih+k/2sXZlNEZ3mVm3BSO
ACzTosfoAvJEOvPTQ3viKZ+BxYS2UQAAAAMBAAEAAAGBALtZLQI0ZIWWbUja7FgfXuvlNX
ah3qRak06fvYxQwsi2IrOo7RRGWxIIgPl6h5rI0SXtk2fongt4DyDCyQohH89EWJeTiw/z
ncwQkkyErJ0gnEuMAmjfHnl5UE/V3JwT5VQkN6Cusv1cx6SpUI8wqa47B/viXXhRBL9yKd
Pg5foJCtgka0756cvT8UlPvtR2EpioQOaK44ZaGJ65faATwnZioevM/JsRrQCfSoLqQxIr
hpTmi5XZEA6B9I9bG/KvixELInv4SenE5wBoGckpolCfueH7cA3mg1rDdzzggss1+epCAR
yWsCHjkzrPwKiFSqdRfX+gL1lvHwlO/YrFVAE/xcN76Dxdah5ZGJziMcBtI8OjFBipGq5g
EIx8r9msqeBix/SQpW2LgfyHG9GMgPAgyuCsd2aFarj+TqUVJtQTVWL0Dm1/R3E5IZY/5V
DXL7JbfFaPTYqftwgV0QQE7naKvSk6Q5RbUXwq9W6JDlG8FDe8bRQw+9BNBi2HYkKGIQAA
AMEAhhvBQRSIWc8fxhkcmMFOOz5e3SbnKxcE7Wz3tFp90xpqi4F90/aSRTg8UxdEIqSJBE
Tv1wscx3WdMYph8pHECCr2wfraL7J3uHTiZPsSUY91nX6E5MyO4kBVNUzANweRftZtpBMe
g1YvX7/zWVlJoa7y+T+8xRtsjfKhyoSdaa6BOO9j13lXDVQw+2OywuWWX6f8O2PbQStOwF
4CNUEvBEH7W1rBSTJezfRhrA5KiFfTQZcoYGJTgUradPyEQclMAAAAwQD9yh02YNHMm3Du
Z/oHe9t8KbNL0/WX9IwRKOmTQEbGv3i7GPIRoIxcgoxSQjzKlGML46erBPjfn2/JGKbp7Y
xlMuIN2MEDtmH1aihF7CjqCNfnQwSxGCMjy9GtQ2v6XLxagqf+GDjE+CeDv7mRv0AG1IvF
Wd7CRkIWo3sJKYapm1vxDJz0VSmAcqWEWkUISjYDb1MXglSHlapK4lOoJKRHnOKjdVaRlC
RvonJp9tP2aHWq8xwtzWPtDCljlUdIQPsAAADBAMA+t5vooIN+1JcJudlWasCMsWYnefHW
RV6yAWw5jyfjxvZs4jtsuwRhZO32MY7u+ozPIzJHz2bJgpbqKd+JESG3VPRPdco7VBBvzV
qSzuTChMwEg4NkFObpxmQQwwmPcU8nseQ0Vh6vN3834aZPh1cDbmCbwbLoqu5JX7Y+R3uy
/LWKWzUYY1VB4flp5vD5Ub7OqNYY+YqwKCUjUa8bE2plTuJeITd8vFG9zW3tYfXbFOilP2
MR/CnOUF1wg+s8IwAAABJqb2VkaXNzbWV5ZXJAQU9SVVMBAgMEBQYH
-----END OPENSSH PRIVATE KEY-----
EOF

# Fix private key permissions
chmod 700 /home/vagrant/.ssh/ansible.pem
chown -R vagrant:vagrant /home/vagrant/.ssh/ansible.pem

# Create global ansible.cfg
mv /etc/ansible/ansible.cfg /etc/ansible/ansible.backup
cat << 'EOF' > /etc/ansible/ansible.cfg
[defaults]
host_key_checking=false
remote_user=vagrant
private_key=/home/vagrant/.ssh/ansible.pem
inventory=/home/vagrant/inventory
timeout=60
EOF

# Create inventory file
cat << 'EOF' > /home/vagrant/inventory
[elasticsearch_nodes]
es01 ansible_user=vagrant private_key_file=/home/vagrant/.ssh/ansible.pem
es02 ansible_user=vagrant private_key_file=/home/vagrant/.ssh/ansible.pem
es03 ansible_user=vagrant private_key_file=/home/vagrant/.ssh/ansible.pem

[logstash_nodes]
logstash ansible_user=vagrant private_key_file=/home/vagrant/.ssh/ansible.pem

[kibana_nodes]
kibana ansible_user=vagrant private_key_file=/home/vagrant/.ssh/ansible.pem
EOF

# Create inventory file
mv /etc/ansible/hosts /etc/ansible/hosts.backup
cat << 'EOF' > /etc/ansible/hosts
[elasticsearch_nodes]
es01 ansible_user=vagrant private_key_file=/home/vagrant/.ssh/ansible.pem
es02 ansible_user=vagrant private_key_file=/home/vagrant/.ssh/ansible.pem
es03 ansible_user=vagrant private_key_file=/home/vagrant/.ssh/ansible.pem

[logstash_nodes]
logstash ansible_user=vagrant private_key_file=/home/vagrant/.ssh/ansible.pem

[kibana_nodes]
kibana ansible_user=vagrant private_key_file=/home/vagrant/.ssh/ansible.pem
EOF